@model IEnumerable<FridgeSystem.Models.EmployeeViewModel>
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery

@{
    ViewData["Title"] = "Employees";

    // Status dropdown
    var statusOptions = new List<SelectListItem>
    {
        new SelectListItem { Text = "All Status", Value = "", Selected = string.IsNullOrEmpty(ViewBag.StatusFilter as string) },
        new SelectListItem { Text = "Active", Value = "active", Selected = (ViewBag.StatusFilter as string) == "active" },
        new SelectListItem { Text = "Inactive", Value = "inactive", Selected = (ViewBag.StatusFilter as string) == "inactive" }
    };

    // Role dropdown
    var roleOptions = new List<SelectListItem>
    {
        new SelectListItem { Text = "All Roles", Value = "" }
    };
    if (ViewBag.RoleOptions is List<SelectListItem> roles)
        roleOptions.AddRange(roles);

    // Province dropdown
    var provinceOptions = new List<SelectListItem>
    {
        new SelectListItem { Text = "All Provinces", Value = "" }
    };
    if (ViewBag.ProvinceOptions is List<SelectListItem> provinces)
        provinceOptions.AddRange(provinces);

    // Warehouse dropdown
    var warehouseOptions = new List<SelectListItem>
    {
        new SelectListItem { Text = "All Warehouses", Value = "" }
    };
    if (ViewBag.WarehouseOptions is List<SelectListItem> warehouses)
        warehouseOptions.AddRange(warehouses);
}

<h1 class="dashboard-title">@ViewData["Title"]</h1>

<!-- Toolbar -->
<div class="toolbar-row mb-3" style="display:flex; gap:10px;">
    <a asp-area="Admin" asp-controller="User" asp-action="AddEmployee" class="form-button add-button">Add Employee</a>
</div>

<!-- Search & Filter Form -->
<form method="get" class="mb-3 d-flex gap-2 flex-wrap align-items-center" id="filterForm">
    <input type="text" name="searchText" value="@ViewBag.SearchText" placeholder="Search employees..." class="form-control" style="max-width: 200px;" />

    <select name="statusFilter" class="form-select" style="max-width: 120px;">
        @foreach (var option in statusOptions)
        {
            <option value="@option.Value" selected="@(option.Selected ? "selected" : null)">@option.Text</option>
        }
    </select>

    <select name="roleFilter" class="form-select" style="max-width: 150px;">
        @foreach (var option in roleOptions)
        {
            <option value="@option.Value" selected="@(ViewBag.RoleFilter == option.Value ? "selected" : null)">
                @option.Text
            </option>
        }
    </select>

    <select name="provinceFilter" class="form-select" style="max-width: 150px;">
        @foreach (var option in provinceOptions)
        {
            <option value="@option.Value" selected="@(ViewBag.ProvinceFilter == option.Value ? "selected" : null)">
                @option.Text
            </option>
        }
    </select>

    <select name="warehouseFilter" class="form-select" style="max-width: 150px;">
        @foreach (var option in warehouseOptions)
        {
            <option value="@option.Value" selected="@(ViewBag.WarehouseFilter == option.Value ? "selected" : null)">
                @option.Text
            </option>
        }
    </select>

    <button type="submit" class="btn btn-primary">Search</button>
</form>

<!-- Responsive Table -->
<div style="overflow-x: auto;">
    <table class="table table-bordered table-striped table-responsive">
        <thead class="table-light">
            <tr>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>City</th>
                <th>Province</th>
                <th>Warehouse</th>
                <th>Roles</th>
                <th>Hired Date</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                @foreach (var emp in Model)
                {
                    <tr>
                        <td>@emp.FirstName</td>
                        <td>@emp.LastName</td>
                        <td>@emp.Email</td>
                        <td>@emp.PhoneNumber</td>
                        <td>@emp.City</td>
                        <td>@emp.Province</td>
                        <td>@emp.Warehouse</td>
                        <td>@string.Join(", ", emp.RoleNames ?? new List<string>())</td>
                        <td>@emp.HiredDate.ToString("yyyy-MM-dd")</td>
                        <td>@(emp.IsActive ? "Active" : "Inactive")</td>
                        <td>
                            <a asp-action="EditEmployee" asp-route-id="@emp.EmployeeId" class="btn btn-sm btn-warning">Edit</a>
                            <form asp-action="DeleteEmployee" asp-route-id="@emp.EmployeeId" method="post" style="display:inline;">
                                <input type="hidden" name="__RequestVerificationToken" value="@Antiforgery.GetAndStoreTokens(Context).RequestToken" />
                                <button type="submit" class="btn btn-sm btn-danger"
                                        onclick="return confirm('Are you sure you want to deactivate this employee?');">
                                    Deactivate
                                </button>
                            </form>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="11" class="text-center">No employees found.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        // Automatically clear filters when "All" is selected
        document.getElementById("filterForm").addEventListener("submit", function (e) {
            const roleSelect = document.querySelector("[name='roleFilter']");
            const provinceSelect = document.querySelector("[name='provinceFilter']");
            const warehouseSelect = document.querySelector("[name='warehouseFilter']");

            if (roleSelect.value === "") roleSelect.name = "";
            if (provinceSelect.value === "") provinceSelect.name = "";
            if (warehouseSelect.value === "") warehouseSelect.name = "";
        });
    </script>
}

